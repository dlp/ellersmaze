%!PS-Adobe-3.0

%(util.ps) run

(Begin\n) print

/maze-width 10 def
/maze-height 10 def

seed dup = srand

/cointoss { % -- => bool
    rand 2 mod 0 eq
} def

/N maze-width def

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Border manipulation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

/border-right  N array def
/border-bottom N array def

/set-bottom-border { % i => --
    border-bottom exch true put
} def

/set-right-border { % i => --
    border-right  exch true put
} def

/clr-bottom-border { % i => --
    border-bottom exch false put
} def

/clr-right-border { % i => --
    border-right  exch false put
} def

% print a maze row based on borders
/print-row { % -- => --
    (|) print % leftmost border
    0 1
    N 1 sub
    { % for 0 .. N-1
        dup % we need the control variable twice
        border-bottom exch get {(___)} {(   )} ifelse print
        border-right  exch get {(|)  } {( )  } ifelse print
    } for
    (\n) print
} def

/print-top {
    ( ) print
    N {(___ ) print} repeat
    (\n) print
} def

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Circular doubly-linked list for managing sets
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

/next N array def
/prev N array def

/are-in-same-set { % u v => bool
    2 dict
    begin
        /v exch def
        /u exch def
        % u.next == v && u == v.prev
        next u get  v  eq
        prev v get  u  eq
        and
    end
} bind def

/make-singleton { % u => --
    dup
    next exch dup put   % u.next = u
    prev exch dup put   % u.prev = u
} bind def

/is-singleton { % u => bool
    dup are-in-same-set
} bind def

/init-sets {
    0 1 N 1 sub { make-singleton } for
} bind def


/is-last-cell-of-set { % u => bool
    dup % u u
    next exch % u next u
    get % u nu
    ge
} bind def

/remove-from-set { % u => --
    1 dict
    begin
        /u exch def
        % u.prev.next = u.next
        prev u get  % load u.prev
        next exch   % prepare .next
        next u get  % load u.next
        put
        % u.next.prev = u.prev
        next u get
        prev exch
        prev u get
        put
        % self-links
        u make-singleton
    end
} bind def

/join-sets { % u v => --
    2 dict
    begin
        /v exch def
        /u exch def

        % u.next.prev = v.prev
        next u get  % load u.next
        prev exch   % prepare .prev
        prev v get  % load v.prev
        put
        % v.prev.next = u.next
        prev v get  % load v.prev
        next exch   % prepare .next
        next u get  % load u.next
        put

        next u v put % u.next = v
        prev v u put % v.prev = u
    end
} bind def

% debugging aid
/show-links {
    (Links:\n) print
    (prev ) print prev ==
    (next ) print next ==
} bind def

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% u,v are defined
/carve-to-right { % -- => --
    u v join-sets
    u clr-right-border
} def

/carve-horizontal-passage { % proc u => proc
    /u exch def
    dup /decision exch def

    u set-right-border
    u N 1 sub lt {
        /v u 1 add def
        u v are-in-same-set not {
            decision { carve-to-right } if
        } if
        v carve-horizontal-passage % tail-recurse
    } if
} bind def

/carve-vertical-passage { % proc u => proc
    /u exch def
    dup /decision exch def

    u clr-bottom-border
    u is-singleton not {
        decision {
            u remove-from-set
            u set-bottom-border
        } if
    } if
    % recurse
    u 1 add dup % proc u' u'
    N lt { carve-vertical-passage } { pop } ifelse
} bind def


/create-row { % proc => --
    0 carve-horizontal-passage
    0 carve-vertical-passage
    pop
} bind def

init-sets
print-top

maze-height 1 sub {
    {cointoss} create-row
    print-row
} repeat

{true} create-row
N 1 sub set-bottom-border % clear last passage
print-row

pstack % should be empty
(End\n) print

%showpage
quit










% A5 page dimensions in mm
/width 148 mm def
/height 210 mm def
/margin 5 mm def

% draw a black border around the page
/draw-border
  { gsave
    0 0 width height rectstroke
    grestore
  } def


/circle-fill-color % stack: - => -
  {
    %205 210 216 setrgbcolor255
    16#f7f6bb setrgbcolorhex
  } def

/circle-stroke-color % stack: - => -
  { 0.1 setgray } def

/draw-circle % stack: x y r => -
  { gsave
      circle
      gsave circle-fill-color fill grestore
      circle-stroke-color 1.0 setlinewidth stroke
    grestore
  } def


% x1 y1 ... bottom left corner
% x2 y2 ... top right corner
% nx ny ... number of cirles horizontally resp. vertically
/draw-circle-array % stack: x1 y1 x2 y2 nx ny => -
  {
    12 dict
    begin
      /ny exch def
      /nx exch def
      % x1 y1 x2 y2
      2 index sub ny div /dy exch def % dy = (y2-y1)/ny
      % x1 y1 x2
      2 index sub nx div /dx exch def % dx = (x2-x1)/nx
      /y1 exch def
      /x1 exch def
      /r dx dy min 0.4 mul def % r = 0.5*0.8 * min(dx, dy)
      /r 6 mm def

      % center of i-th circle
      % mz_i = z1 + dz (0.5 + i)
      /mx_i % stack: i => mx_i
        { 0.5 add dx mul x1 add } def
      /my_i % stack: i => my_i
        { 0.5 add dy mul y1 add } def

      % print a row of circles
      /draw-circle-row % stack: my => my
        { % 0 .. nx-1
          0 1 nx 1 sub { mx_i 2dup r draw-circle } for
        } def

      % print rows:
      % 0 .. ny-1
      0 1 ny 1 sub { my_i draw-circle-row pop } for
    end
  } def


% Print "Name: _______" at baseline h
/name-line % stack: h => -
  { 1 dict
    begin
      /baseline exch def
      gsave
        margin baseline
        moveto
        /ComicSansMS findfont
        24 scalefont setfont
        (Name:) show
        3 mm -2 mm rmoveto
        width margin sub
        baseline -2 mm add
        lineto
        stroke
      grestore
    end
  } def


% scale whole system for mm units
% (NB: won't work as desired as also the linewidth is scaled)
%/scalefactor 1 mm def
%scalefactor dup scale

% move away from border / add page margin
25 mm dup translate

% A5 => A6
0.7063 dup scale

draw-border

% draw circles field in bottom half
margin dup
width margin sub
height 0.5 mul margin sub
10 6 draw-circle-array


% title with shadow
/ComicSansMS-Bold findfont
40 scalefont setfont
width 2 div
height 20 mm sub
moveto
(Sammelpass) center-text
16#ff6600 setrgbcolorhex
1.7 mm text-shadowed-outlined


% name line at (height - 40 mm)
0.0 setgray
height 38 mm sub name-line

% rectangle for ad/toy sticker
gsave
margin
height 0.5 mul 2 mm add
width margin 2 mul sub
height 0.5 mul 44 mm sub
4 copy
gsave 0.95 setgray rectfill grestore
rectstroke
grestore


/ComicSansMS findfont
18 scalefont setfont
(\(Wunsch hier aufkleben\))
dup stringwidth pop
width exch sub 2 div
height 0.65 mul
moveto
show

showpage
quit
